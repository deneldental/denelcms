(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,667585,(e,t,a)=>{"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"BailoutToCSR",{enumerable:!0,get:function(){return l}});let n=e.r(775692);function l({reason:e,children:t}){if("undefined"==typeof window)throw Object.defineProperty(new n.BailoutToCSRError(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});return t}},309885,(e,t,a)=>{"use strict";function n(e){return e.split("/").map(e=>encodeURIComponent(e)).join("/")}Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"encodeURIPath",{enumerable:!0,get:function(){return n}})},652157,(e,t,a)=>{"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"PreloadChunks",{enumerable:!0,get:function(){return o}});let n=e.r(843476),l=e.r(174080),i=e.r(563599),s=e.r(309885),r=e.r(543369);function o({moduleIds:e}){if("undefined"!=typeof window)return null;let t=i.workAsyncStorage.getStore();if(void 0===t)return null;let a=[];if(t.reactLoadableManifest&&e){let n=t.reactLoadableManifest;for(let t of e){if(!n[t])continue;let e=n[t].files;a.push(...e)}}if(0===a.length)return null;let o=(0,r.getDeploymentIdQueryOrEmptyString)();return(0,n.jsx)(n.Fragment,{children:a.map(e=>{let a=`${t.assetPrefix}/_next/${(0,s.encodeURIPath)(e)}${o}`;return e.endsWith(".css")?(0,n.jsx)("link",{precedence:"dynamic",href:a,rel:"stylesheet",as:"style",nonce:t.nonce},e):((0,l.preload)(a,{as:"script",fetchPriority:"low",nonce:t.nonce}),null)})})}},869093,(e,t,a)=>{"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"default",{enumerable:!0,get:function(){return d}});let n=e.r(843476),l=e.r(271645),i=e.r(667585),s=e.r(652157);function r(e){return{default:e&&"default"in e?e.default:e}}let o={loader:()=>Promise.resolve(r(()=>null)),loading:null,ssr:!0},d=function(e){let t={...o,...e},a=(0,l.lazy)(()=>t.loader().then(r)),d=t.loading;function c(e){let r=d?(0,n.jsx)(d,{isLoading:!0,pastDelay:!0,error:null}):null,o=!t.ssr||!!t.loading,c=o?l.Suspense:l.Fragment,u=t.ssr?(0,n.jsxs)(n.Fragment,{children:["undefined"==typeof window?(0,n.jsx)(s.PreloadChunks,{moduleIds:t.modules}):null,(0,n.jsx)(a,{...e})]}):(0,n.jsx)(i.BailoutToCSR,{reason:"next/dynamic",children:(0,n.jsx)(a,{...e})});return(0,n.jsx)(c,{...o?{fallback:r}:{},children:u})}return c.displayName="LoadableComponent",c}},770703,(e,t,a)=>{"use strict";Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(a,"default",{enumerable:!0,get:function(){return l}});let n=e.r(555682)._(e.r(869093));function l(e,t){let a={};"function"==typeof e&&(a.loader=e);let l={...a,...t};return(0,n.default)({...l,modules:l.loadableGenerated?.modules})}("function"==typeof a.default||"object"==typeof a.default&&null!==a.default)&&void 0===a.default.__esModule&&(Object.defineProperty(a.default,"__esModule",{value:!0}),Object.assign(a.default,a),t.exports=a.default)},77861,e=>{"use strict";var t=e.i(843476),a=e.i(271645),n=e.i(127341),l=e.i(167881),i=e.i(98865),s=e.i(247167),r=e.i(522016),o=e.i(561654),d=e.i(994179),c=e.i(463415),u=e.i(541071),m=e.i(303281),p=e.i(286536),h=e.i(727612),y=e.i(95187);let x=(0,y.createServerReference)("4087085cb43ade3f557b5463aeb802122887fecfcc",y.callServer,void 0,y.findSourceMapURL,"deletePayment");var j=e.i(416355),f=e.i(762332),g=e.i(685946),v=e.i(846696),P=e.i(618566),b=e.i(133308),N=e.i(740636),C=e.i(401851);let S=[{accessorKey:"createdAt",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Date"}),cell:({row:e})=>{let a=e.getValue("createdAt");return(0,t.jsx)("div",{children:new Date(a).toLocaleDateString()})}},{accessorKey:"patient.name",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Patient"}),cell:({row:e})=>{let a=e.original.patient?.id,n=e.original.patient?.name||"Unknown";return a?(0,t.jsx)(r.default,{href:`/patients/${a}`,className:"hover:underline text-primary font-medium",children:n}):(0,t.jsx)("div",{children:n})}},{accessorKey:"patient.patientId",id:"patientId",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"ID"}),cell:({row:e})=>(0,t.jsx)("div",{children:e.original.patient?.patientId||"-"})},{accessorKey:"totalAmount",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Total Amount"}),cell:({row:e})=>{let a=e.getValue("totalAmount"),n=new Intl.NumberFormat("en-US",{style:"currency",currency:"GHS"}).format(a/100);return(0,t.jsx)("div",{className:"font-medium",children:n})}},{accessorKey:"amountPerInstallment",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Installment"}),cell:({row:e})=>{let a=e.getValue("amountPerInstallment"),n=new Intl.NumberFormat("en-US",{style:"currency",currency:"GHS"}).format(a/100);return(0,t.jsx)("div",{children:n})}},{accessorKey:"paymentFrequency",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Frequency"}),cell:({row:e})=>{let a=e.getValue("paymentFrequency");return(0,t.jsx)("div",{className:"capitalize",children:a})}},{accessorKey:"status",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Status"}),cell:({row:e})=>{let a=e.getValue("status");return(0,t.jsx)(d.Badge,{variant:"completed"===a?"default":"overdue"===a?"destructive":"secondary",children:a})}},{id:"actions",cell:({row:e})=>{let a=(0,P.useRouter)();return(0,t.jsxs)(l.Button,{variant:"ghost",size:"sm",onClick:()=>a.push(`/payment-plans/${e.original.id}`),children:[(0,t.jsx)(p.Eye,{className:"mr-2 h-4 w-4"}),"View Details"]})}}];function I(e){if(!e)return{treatmentTypes:"-",additionalNotes:null};let t=e.split(" - ");return{treatmentTypes:t[0]||"-",additionalNotes:t.length>1?t.slice(1).join(" - "):null}}function w({payment:e}){let n=(0,P.useRouter)(),[i,r]=(0,a.useState)(!1),[o,d]=(0,a.useState)(!1),[y,S]=(0,a.useState)(null),[I,w]=(0,a.useState)(!1),T=async()=>{try{let t,a;if(!e.patient)return void v.toast.error("Patient information not available");if(e.paymentPlanId&&e.patientId)if(null!==e.balance&&void 0!==e.balance){a=e.balance;let n=await (0,f.getPaymentPlanByPatientId)(e.patientId);n.success&&n.data&&(t=n.data.totalAmount)}else{let[n,l]=await Promise.all([(0,f.getPaymentPlanByPatientId)(e.patientId),(0,j.getPaymentsByPatientId)(e.patientId)]);if(n.success&&n.data){t=n.data.totalAmount;let e=(l.success?l.data.filter(e=>"completed"===e.status&&e.paymentPlanId===n.data?.id):[]).reduce((e,t)=>e+t.amount,0);a=n.data.totalAmount-e}}(0,g.generatePaymentReceipt)({patientName:e.patient.name,amountPaid:e.amount,paymentMethod:e.method,description:e.paymentPlanId&&e.paymentPlan?e.description||e.paymentPlan.notes||void 0:e.description||void 0,appointmentDate:e.createdAt,paymentPlanTotal:t,paymentPlanBalance:a,paymentType:e.paymentPlanId?"plan":"one-time",autoPrint:!0})}catch(e){console.error("Failed to generate receipt:",e),v.toast.error("Failed to generate receipt")}},D=async()=>{let t,a,n;if(!e.patient)return v.toast.error("Patient information not available"),null;if(e.paymentPlanId&&e.patientId)if(null!==e.balance&&void 0!==e.balance){a=e.balance;let n=await (0,f.getPaymentPlanByPatientId)(e.patientId);n.success&&n.data&&(t=n.data.totalAmount)}else{let[n,l]=await Promise.all([(0,f.getPaymentPlanByPatientId)(e.patientId),(0,j.getPaymentsByPatientId)(e.patientId)]);if(n.success&&n.data){t=n.data.totalAmount;let e=(l.success?l.data.filter(e=>"completed"===e.status&&e.paymentPlanId===n.data?.id):[]).reduce((e,t)=>e+t.amount,0);a=n.data.totalAmount-e}}if(e.createdAt)try{let t="string"==typeof e.createdAt?new Date(e.createdAt):e.createdAt;n=(0,C.format)(t,"MMMM d, yyyy h:mm a")}catch{n=void 0}let l=e.amount/100,i=t?t/100:void 0,r=void 0!==a?a/100:void 0;return{patientName:e.patient.name,appointmentDate:n,amountPaid:l,totalAmount:i,balance:r,paymentType:e.method,paymentFor:e.paymentPlanId?"Ortho Payment":e.description||"Service Payment",notes:e.description||null,clinicName:s.default.env.NEXT_PUBLIC_CLINIC_NAME||"Framada Dental Clinic",clinicPhone:s.default.env.NEXT_PUBLIC_CLINIC_PHONE||null,clinicAddress:s.default.env.NEXT_PUBLIC_CLINIC_ADDRESS||null,generatedAt:new Date().toLocaleString()}},A=async()=>{try{let e=await D();e&&(S(e),d(!0))}catch(e){console.error("Failed to prepare receipt:",e),v.toast.error("Failed to load receipt")}},F=async()=>{w(!0);try{let t=await x(e.id);t.success?(v.toast.success("Payment deleted successfully"),n.refresh()):v.toast.error(t.error||"Failed to delete payment")}catch{v.toast.error("An error occurred while deleting the payment")}finally{w(!1),r(!1)}};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(c.DropdownMenu,{children:[(0,t.jsx)(c.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsxs)(l.Button,{variant:"ghost",className:"h-8 w-8 p-0",children:[(0,t.jsx)("span",{className:"sr-only",children:"Open menu"}),(0,t.jsx)(u.MoreHorizontal,{className:"h-4 w-4"})]})}),(0,t.jsxs)(c.DropdownMenuContent,{align:"end",children:[(0,t.jsxs)(c.DropdownMenuItem,{onClick:e=>{e.stopPropagation(),T()},children:[(0,t.jsx)(m.Printer,{className:"mr-2 h-4 w-4"}),"Print Receipt"]}),(0,t.jsxs)(c.DropdownMenuItem,{onClick:e=>{e.stopPropagation(),A()},children:[(0,t.jsx)(p.Eye,{className:"mr-2 h-4 w-4"}),"View Receipt"]}),(0,t.jsx)(c.DropdownMenuSeparator,{}),(0,t.jsxs)(c.DropdownMenuItem,{onClick:e=>{e.stopPropagation(),r(!0)},className:"text-destructive",children:[(0,t.jsx)(h.Trash2,{className:"mr-2 h-4 w-4"}),"Delete"]})]})]}),(0,t.jsx)(b.DeleteConfirmationDialog,{open:i,onOpenChange:r,onConfirm:F,title:"Delete Payment",description:"Are you sure you want to delete this payment? This action cannot be undone.",itemName:`Payment of ${new Intl.NumberFormat("en-US",{style:"currency",currency:"GHS"}).format(e.amount/100)}`,isLoading:I}),y&&(0,t.jsx)(N.ReceiptViewDialog,{open:o,onOpenChange:d,receiptData:y})]})}let T=[{accessorKey:"createdAt",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Date"}),cell:({row:e})=>{let a=e.getValue("createdAt");return(0,t.jsx)("div",{children:new Date(a).toLocaleDateString()})}},{accessorKey:"patient.name",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Patient"}),cell:({row:e})=>(0,t.jsx)("div",{children:e.original.patient?.name||"Walk-in"})},{accessorKey:"amount",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Amount"}),cell:({row:e})=>{let a=e.getValue("amount"),n=new Intl.NumberFormat("en-US",{style:"currency",currency:"GHS"}).format(a/100);return(0,t.jsx)("div",{className:"font-medium",children:n})}},{accessorKey:"method",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Method"}),cell:({row:e})=>{let a=e.getValue("method");return(0,t.jsx)("div",{className:"capitalize",children:a.replace("_"," ")})}},{accessorKey:"status",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Status"}),cell:({row:e})=>{let a=e.getValue("status");return(0,t.jsx)(d.Badge,{variant:"completed"===a?"default":"pending"===a?"secondary":"failed"===a?"destructive":"outline",children:a})}},{accessorKey:"description",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Treatment Types"}),cell:({row:e})=>{let{treatmentTypes:a}=I(e.getValue("description"));return(0,t.jsx)("div",{children:a})}},{id:"additionalNotes",accessorFn:e=>{let{additionalNotes:t}=I(e.description);return t},header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Additional Notes"}),cell:({row:e})=>{let{additionalNotes:a}=I(e.original.description);return(0,t.jsx)("div",{className:"text-muted-foreground",children:a||"-"})}},{id:"actions",cell:({row:e})=>(0,t.jsx)(w,{payment:e.original})}],D=[{accessorKey:"createdAt",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Date"}),cell:({row:e})=>{let a=e.getValue("createdAt");return(0,t.jsx)("div",{children:new Date(a).toLocaleDateString()})}},{accessorKey:"patient.name",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Patient"}),cell:({row:e})=>(0,t.jsx)("div",{children:e.original.patient?.name||"Unknown"})},{accessorKey:"amount",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Amount"}),cell:({row:e})=>{let a=e.getValue("amount"),n=new Intl.NumberFormat("en-US",{style:"currency",currency:"GHS"}).format(a/100);return(0,t.jsx)("div",{className:"font-medium",children:n})}},{accessorKey:"method",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Method"}),cell:({row:e})=>{let a=e.getValue("method");return(0,t.jsx)("div",{className:"capitalize",children:a.replace("_"," ")})}},{accessorKey:"status",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Status"}),cell:({row:e})=>{let a=e.getValue("status");return(0,t.jsx)(d.Badge,{variant:"completed"===a?"default":"pending"===a?"secondary":"failed"===a?"destructive":"outline",children:a})}},{accessorKey:"description",header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Treatment Types"}),cell:({row:e})=>{let{treatmentTypes:a}=I(e.getValue("description"));return(0,t.jsx)("div",{children:a})}},{id:"additionalNotes",accessorFn:e=>{let{additionalNotes:t}=I(e.description);return t},header:({column:e})=>(0,t.jsx)(o.DataTableColumnHeader,{column:e,title:"Additional Notes"}),cell:({row:e})=>{let{additionalNotes:a}=I(e.original.description);return(0,t.jsx)("div",{className:"text-muted-foreground",children:a||"-"})}},{id:"actions",cell:({row:e})=>(0,t.jsx)(w,{payment:e.original})}];var A=e.i(630374),F=e.i(561659),M=e.i(512841),M=M,O=e.i(23750),L=e.i(10708),B=e.i(62870),k=e.i(625959),H=e.i(59377),_=e.i(753751),R=e.i(531278),V=e.i(871689),$=e.i(643531),E=e.i(344523),K=e.i(647163),U=e.i(899988),G=e.i(23467);let q=(0,y.createServerReference)("405d5ca820b8de1125eed3088acc6716c9e586df45",y.callServer,void 0,y.findSourceMapURL,"getPatient");var z=e.i(993766),X=e.i(131343),W=e.i(335883);function Q({open:e,onOpenChange:n,onSuccess:i}){let s,[r,o]=(0,a.useState)(!1),[d,c]=(0,a.useState)([]),[u,m]=(0,a.useState)([]),[p,h]=(0,a.useState)(!1),[y,x]=(0,a.useState)({patientId:"",amount:"",method:"",description:"",sendNotification:!0}),[j,f]=(0,a.useState)([]),[P,b]=(0,a.useState)([]);(0,a.useEffect)(()=>{e&&(S(),C(),N())},[e]);let N=async()=>{let e=await (0,X.getTreatmentTypes)();e.success&&e.data&&b(e.data)},C=async()=>{let e=await (0,z.getPaymentMethods)();if(e.success&&e.data&&(m(e.data),e.data.length>0)){let t=e.data.find(e=>"cash"===e.name);x(a=>({...a,method:t?"cash":e.data[0].name}))}},S=async()=>{let e=await (0,G.getPatients)();e.success&&e.data&&c(e.data)},I=async e=>{e.preventDefault(),o(!0);try{if(!y.patientId){v.toast.error("Please select a patient"),o(!1);return}if(!y.amount||0>=parseFloat(y.amount)){v.toast.error("Please enter a valid amount"),o(!1);return}if(0===j.length){v.toast.error("Please select at least one treatment type"),o(!1);return}let e=P.filter(e=>j.includes(e.id)).map(e=>e.displayName||e.name).join(", ");y.description.trim()&&(e=`${e} - ${y.description.trim()}`);let t={patientId:y.patientId,amount:Math.round(100*parseFloat(y.amount)),method:y.method,status:"completed",description:e,sendNotification:y.sendNotification??!1},a=await (0,U.createPayment)(t);if(a.success){a.smsError?v.toast.warning(`Payment recorded, but SMS failed: ${a.smsError}`):v.toast.success("Payment recorded successfully");try{let a=await q(y.patientId);a.success&&a.data&&(0,g.generatePaymentReceipt)({patientName:a.data.name,amountPaid:t.amount,paymentMethod:y.method,description:e,paymentType:"one-time"})}catch{console.error("Failed to generate receipt")}n(!1);let l=u.find(e=>"cash"===e.name)?.name||u[0]?.name||"";x({patientId:"",amount:"",method:l,description:"",sendNotification:!0}),f([]),i?.()}else v.toast.error(a.error||"Failed to record payment")}catch{v.toast.error("An error occurred while recording the payment")}finally{o(!1)}};return(0,t.jsx)(A.Dialog,{open:e,onOpenChange:n,children:(0,t.jsx)(A.DialogContent,{className:"sm:max-w-[500px]",children:(0,t.jsxs)("form",{onSubmit:I,children:[(0,t.jsxs)(A.DialogHeader,{children:[(0,t.jsx)(A.DialogTitle,{children:"One-time Payment"}),(0,t.jsx)(A.DialogDescription,{children:"Record a one-time payment for a patient."})]}),(0,t.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{htmlFor:"patient",children:"Select Patient *"}),(0,t.jsxs)(H.Popover,{open:p,onOpenChange:h,children:[(0,t.jsx)(H.PopoverTrigger,{asChild:!0,children:(0,t.jsxs)(l.Button,{variant:"outline",role:"combobox","aria-expanded":p,className:"w-full justify-between",children:[y.patientId&&(s=d.find(e=>e.id===y.patientId))?`${s.name} ${s.patientId?`(${s.patientId})`:""}`:"Select a patient",(0,t.jsx)(E.ChevronsUpDown,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,t.jsx)(H.PopoverContent,{className:"w-[400px] p-0",children:(0,t.jsxs)(_.Command,{children:[(0,t.jsx)(_.CommandInput,{placeholder:"Search patients..."}),(0,t.jsxs)(_.CommandList,{children:[(0,t.jsx)(_.CommandEmpty,{children:"No patient found."}),(0,t.jsx)(_.CommandGroup,{children:d.map(e=>(0,t.jsxs)(_.CommandItem,{value:`${e.name} ${e.patientId||""}`,onSelect:()=>{x({...y,patientId:e.id}),h(!1)},children:[(0,t.jsx)($.Check,{className:(0,K.cn)("mr-2 h-4 w-4",y.patientId===e.id?"opacity-100":"opacity-0")}),e.name," ",e.patientId&&`(${e.patientId})`]},e.id))})]})]})})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{htmlFor:"amount",children:"Amount (GHS) *"}),(0,t.jsx)(O.Input,{id:"amount",type:"number",step:"0.01",min:"0",value:y.amount,onChange:e=>x({...y,amount:e.target.value}),required:!0})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{htmlFor:"method",children:"Payment Method *"}),(0,t.jsxs)(B.Select,{value:y.method,onValueChange:e=>x({...y,method:e}),required:!0,children:[(0,t.jsx)(B.SelectTrigger,{children:(0,t.jsx)(B.SelectValue,{placeholder:"Select payment method"})}),(0,t.jsx)(B.SelectContent,{children:u.map(e=>(0,t.jsx)(B.SelectItem,{value:e.name,children:e.displayName||e.name.replace("_"," ")},e.id))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{children:"Treatment Types *"}),(0,t.jsx)(W.TreatmentTypesMultiSelect,{value:j,onChange:f,placeholder:"Select treatment types..."})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{htmlFor:"description",children:"Additional Notes (Optional)"}),(0,t.jsx)(O.Input,{id:"description",value:y.description,onChange:e=>x({...y,description:e.target.value}),placeholder:"Additional payment notes"})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(k.Checkbox,{id:"sendNotification",checked:y.sendNotification,onCheckedChange:e=>x({...y,sendNotification:!0===e})}),(0,t.jsx)(L.Label,{htmlFor:"sendNotification",className:"cursor-pointer",children:"Send Payment Notification (SMS)"})]})]}),(0,t.jsxs)(A.DialogFooter,{children:[(0,t.jsxs)(l.Button,{type:"button",variant:"outline",onClick:()=>n(!1),disabled:r,children:[(0,t.jsx)(V.ArrowLeft,{className:"mr-2 h-4 w-4"}),"Back"]}),(0,t.jsxs)(l.Button,{type:"submit",disabled:r||0===j.length,children:[r&&(0,t.jsx)(R.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"Record Payment"]})]})]})})})}var J=e.i(905838);function Y({open:e,onOpenChange:n,onSuccess:i}){let s,[r,o]=(0,a.useState)(!1),[d,c]=(0,a.useState)([]),[u,m]=(0,a.useState)(null),[p,h]=(0,a.useState)(null),[y,x]=(0,a.useState)(0),[P,b]=(0,a.useState)([]),[N,C]=(0,a.useState)(!1),[S,I]=(0,a.useState)({patientId:"",amount:"",method:"",description:"",sendNotification:!0}),[w,T]=(0,a.useState)([]),[D,F]=(0,a.useState)([]);(0,a.useEffect)(()=>{e&&(Q(),q(),M())},[e]);let M=async()=>{let e=await (0,X.getTreatmentTypes)();e.success&&e.data&&F(e.data)},q=async()=>{let e=await (0,z.getPaymentMethods)();if(e.success&&e.data&&(b(e.data),e.data.length>0)){let t=e.data.find(e=>"cash"===e.name);I(a=>({...a,method:t?"cash":e.data[0].name}))}};(0,a.useEffect)(()=>{S.patientId?Y():(m(null),h(null),x(0))},[S.patientId]);let Q=async()=>{let e=await (0,G.getPatients)();e.success&&e.data&&c(e.data.filter(e=>e.isOrtho||"legacy"===e.type))},Y=async()=>{let e=d.find(e=>e.id===S.patientId);if(!e)return;m(e);let[t,a]=await Promise.all([(0,f.getPaymentPlanByPatientId)(e.id),(0,j.getPaymentsByPatientId)(e.id)]);if(t.success&&t.data){h(t.data);let e=(a.success?a.data.filter(e=>"completed"===e.status&&e.paymentPlanId===t.data?.id):[]).reduce((e,t)=>e+t.amount,0);x(t.data.totalAmount-e)}else h(null),x(0)},Z=async e=>{e.preventDefault(),o(!0);try{if(!S.patientId){v.toast.error("Please select a patient"),o(!1);return}if(!p){v.toast.error("Selected patient does not have a payment plan"),o(!1);return}if(!S.amount||0>=parseFloat(S.amount)){v.toast.error("Please enter a valid amount"),o(!1);return}let e=Math.round(100*parseFloat(S.amount));if(e>y){v.toast.error("Payment amount cannot exceed outstanding balance"),o(!1);return}let t="";w.length>0&&(t=D.filter(e=>w.includes(e.id)).map(e=>e.displayName||e.name).join(", ")),S.description.trim()&&(t=t?`${t} - ${S.description.trim()}`:S.description.trim());let a={patientId:S.patientId,paymentPlanId:p.id,amount:e,method:S.method,status:"completed",description:t||null,sendNotification:S.sendNotification??!1},l=await (0,U.createPayment)(a);if(l.success){l.smsError?v.toast.warning(`Payment recorded, but SMS failed: ${l.smsError}`):v.toast.success("Payment recorded successfully");try{if(u&&p){let a=y-e,n=t||p.notes||"Payment Plan Installment";(0,g.generatePaymentReceipt)({patientName:u.name,amountPaid:e,paymentMethod:S.method,description:n,paymentPlanTotal:p.totalAmount,paymentPlanBalance:a,paymentType:"plan"})}}catch(e){console.error("Failed to generate receipt:",e)}n(!1);let a=P.find(e=>"cash"===e.name)?.name||P[0]?.name||"";I({patientId:"",amount:"",method:a,description:"",sendNotification:!0}),m(null),h(null),x(0),T([]),i?.()}else v.toast.error(l.error||"Failed to record payment")}catch{v.toast.error("An error occurred while recording the payment")}finally{o(!1)}};return(0,t.jsx)(A.Dialog,{open:e,onOpenChange:n,children:(0,t.jsx)(A.DialogContent,{className:"sm:max-w-[500px]",children:(0,t.jsxs)("form",{onSubmit:Z,children:[(0,t.jsxs)(A.DialogHeader,{children:[(0,t.jsx)(A.DialogTitle,{children:"Payment Plan Payment"}),(0,t.jsx)(A.DialogDescription,{children:"Record a payment towards a patient's payment plan."})]}),(0,t.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{htmlFor:"patient",children:"Select Patient *"}),(0,t.jsxs)(H.Popover,{open:N,onOpenChange:C,children:[(0,t.jsx)(H.PopoverTrigger,{asChild:!0,children:(0,t.jsxs)(l.Button,{variant:"outline",role:"combobox","aria-expanded":N,className:"w-full justify-between",children:[S.patientId&&(s=d.find(e=>e.id===S.patientId))?`${s.name} ${s.patientId?`(${s.patientId})`:""}`:"Select a patient",(0,t.jsx)(E.ChevronsUpDown,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,t.jsx)(H.PopoverContent,{className:"w-[400px] p-0",children:(0,t.jsxs)(_.Command,{children:[(0,t.jsx)(_.CommandInput,{placeholder:"Search patients..."}),(0,t.jsxs)(_.CommandList,{children:[(0,t.jsx)(_.CommandEmpty,{children:"No patient found."}),(0,t.jsx)(_.CommandGroup,{children:d.map(e=>(0,t.jsxs)(_.CommandItem,{value:`${e.name} ${e.patientId||""}`,onSelect:()=>{I({...S,patientId:e.id}),C(!1)},children:[(0,t.jsx)($.Check,{className:(0,K.cn)("mr-2 h-4 w-4",S.patientId===e.id?"opacity-100":"opacity-0")}),e.name," ",e.patientId&&`(${e.patientId})`]},e.id))})]})]})})]})]}),u&&p&&(0,t.jsx)("div",{className:"rounded-lg border p-4 space-y-2 bg-muted/50",children:(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Total Amount:"}),(0,t.jsx)("p",{className:"font-semibold",children:(0,J.formatCurrency)(p.totalAmount)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Outstanding Balance:"}),(0,t.jsx)("p",{className:"font-semibold text-destructive",children:(0,J.formatCurrency)(y)})]})]})}),u&&!p&&(0,t.jsx)("div",{className:"rounded-lg border p-4 bg-yellow-50 dark:bg-yellow-900/20",children:(0,t.jsx)("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:"This patient does not have an active payment plan."})}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{htmlFor:"amount",children:"Amount (GHS) *"}),(0,t.jsx)(O.Input,{id:"amount",type:"number",step:"0.01",min:"0",max:y/100,value:S.amount,onChange:e=>I({...S,amount:e.target.value}),required:!0,disabled:!p}),p&&y>0&&(0,t.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Maximum: ",(0,J.formatCurrency)(y)]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{htmlFor:"method",children:"Payment Method *"}),(0,t.jsxs)(B.Select,{value:S.method,onValueChange:e=>I({...S,method:e}),required:!0,children:[(0,t.jsx)(B.SelectTrigger,{children:(0,t.jsx)(B.SelectValue,{placeholder:"Select payment method"})}),(0,t.jsx)(B.SelectContent,{children:P.map(e=>(0,t.jsx)(B.SelectItem,{value:e.name,children:e.displayName||e.name.replace("_"," ")},e.id))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{children:"Treatment Types (Optional)"}),(0,t.jsx)(W.TreatmentTypesMultiSelect,{value:w,onChange:T,placeholder:"Select treatment types..."}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Select treatments to override the default receipt description."})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(L.Label,{htmlFor:"description",children:"Description (Optional)"}),(0,t.jsx)(O.Input,{id:"description",value:S.description,onChange:e=>I({...S,description:e.target.value}),placeholder:"Payment description"})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(k.Checkbox,{id:"sendNotification",checked:S.sendNotification,onCheckedChange:e=>I({...S,sendNotification:!0===e})}),(0,t.jsx)(L.Label,{htmlFor:"sendNotification",className:"cursor-pointer",children:"Send Payment Notification (SMS)"})]})]}),(0,t.jsxs)(A.DialogFooter,{children:[(0,t.jsxs)(l.Button,{type:"button",variant:"outline",onClick:()=>n(!1),disabled:r,children:[(0,t.jsx)(V.ArrowLeft,{className:"mr-2 h-4 w-4"}),"Back"]}),(0,t.jsxs)(l.Button,{type:"submit",disabled:r||!p,children:[r&&(0,t.jsx)(R.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"Record Payment"]})]})]})})})}function Z({open:e,onOpenChange:n,onSuccess:i}){let[s,r]=(0,a.useState)(null),o=e=>{r(e)},d=e=>{e||r(null),n(e)};return"one-time"===s?(0,t.jsx)(Q,{open:e,onOpenChange:d,onSuccess:()=>{r(null),i?.()}}):"plan"===s?(0,t.jsx)(Y,{open:e,onOpenChange:d,onSuccess:()=>{r(null),i?.()}}):(0,t.jsx)(A.Dialog,{open:e,onOpenChange:d,children:(0,t.jsxs)(A.DialogContent,{className:"sm:max-w-[400px]",children:[(0,t.jsxs)(A.DialogHeader,{children:[(0,t.jsx)(A.DialogTitle,{children:"Accept Payment"}),(0,t.jsx)(A.DialogDescription,{children:"Select the type of payment you want to accept."})]}),(0,t.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,t.jsxs)(l.Button,{variant:"outline",className:"h-20 flex-col gap-2",onClick:()=>o("one-time"),children:[(0,t.jsx)(M.default,{className:"h-6 w-6"}),(0,t.jsx)("span",{children:"One-time Payment"})]}),(0,t.jsxs)(l.Button,{variant:"outline",className:"h-20 flex-col gap-2",onClick:()=>o("plan"),children:[(0,t.jsx)(F.CreditCard,{className:"h-6 w-6"}),(0,t.jsx)("span",{children:"Payment Plan"})]})]}),(0,t.jsx)(A.DialogFooter,{children:(0,t.jsx)(l.Button,{variant:"outline",onClick:()=>d(!1),children:"Cancel"})})]})})}let ee=(0,e.i(770703).default)(()=>e.A(115060).then(e=>e.Plus),{loadableGenerated:{modules:[796380]},ssr:!1,loading:()=>(0,t.jsx)("span",{className:"mr-2",children:"+"})});function et({oneTimePayments:e,planPayments:s,activePlans:r,overduePlans:o,outstandingPlans:d}){let[c,u]=(0,a.useState)(!1),m=(0,P.useRouter)();return(0,t.jsxs)("div",{className:"flex flex-col gap-6 p-6",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-3xl font-bold tracking-tight",children:"Payments"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Track patient payments and invoices."})]}),(0,t.jsxs)(l.Button,{onClick:()=>u(!0),children:[(0,t.jsx)(ee,{className:"mr-2 h-4 w-4"}),"Accept Payment"]}),(0,t.jsx)(Z,{open:c,onOpenChange:u,onSuccess:()=>{m.refresh()}})]}),(0,t.jsxs)(n.Tabs,{defaultValue:"active-plans",className:"w-full",children:[(0,t.jsxs)(n.TabsList,{children:[(0,t.jsx)(n.TabsTrigger,{value:"active-plans",children:"Active Plans"}),(0,t.jsx)(n.TabsTrigger,{value:"one-time",children:"One-time Payments"}),(0,t.jsx)(n.TabsTrigger,{value:"transactions",children:"Plan Transactions"}),(0,t.jsx)(n.TabsTrigger,{value:"overdue",children:"Overdue Payments"}),(0,t.jsx)(n.TabsTrigger,{value:"outstanding",children:"Outstanding"})]}),(0,t.jsx)(n.TabsContent,{value:"active-plans",children:(0,t.jsx)(i.DataTable,{columns:S,data:r,initialColumnVisibility:{patientId:!1,status:!1}})}),(0,t.jsx)(n.TabsContent,{value:"one-time",children:(0,t.jsx)(i.DataTable,{columns:T,data:e,initialColumnVisibility:{additionalNotes:!1}})}),(0,t.jsx)(n.TabsContent,{value:"transactions",children:(0,t.jsx)(i.DataTable,{columns:D,data:s,initialColumnVisibility:{additionalNotes:!1}})}),(0,t.jsx)(n.TabsContent,{value:"overdue",children:(0,t.jsx)(i.DataTable,{columns:S,data:o,initialColumnVisibility:{patientId:!1,status:!1,createdAt:!1}})}),(0,t.jsx)(n.TabsContent,{value:"outstanding",children:(0,t.jsx)(i.DataTable,{columns:S,data:d,initialColumnVisibility:{patientId:!1,status:!1,createdAt:!1}})})]})]})}e.s(["PaymentsContent",()=>et],77861)}]);